<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportsPass - Premium Sports Tickets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1); }
        .loading { display: none; }
        .loading.active { display: inline-block; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 gradient-bg rounded-lg flex items-center justify-center">
                        <i class="fas fa-ticket-alt text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900">SportsPass</h1>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="#events" class="text-gray-600 hover:text-blue-600 transition-colors">Events</a>
                    <a href="#about" class="text-gray-600 hover:text-blue-600 transition-colors">About</a>
                    <button id="cartBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Cart (<span id="cartCount">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="gradient-bg py-20 text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-5xl font-bold mb-6">Premium Sports Tickets</h1>
            <p class="text-xl mb-8 max-w-2xl mx-auto">Experience the thrill of live sports. Pay securely with cryptocurrency.</p>
            <button onclick="scrollToEvents()" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                Browse Events
            </button>
        </div>
    </section>

    <!-- Events Section -->
    <section id="events" class="py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-center mb-12">Upcoming Events</h2>
            <div id="eventsGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>
    </section>

    <!-- Cart Modal -->
    <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">Your Cart</h3>
                        <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div id="cartItems" class="space-y-4 mb-6"></div>

                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-xl font-bold">Total: $<span id="cartTotal">0.00</span></span>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                <input type="email" id="customerEmail" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="your@email.com" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Network</label>
                                <select id="paymentNetwork" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="">Loading networks...</option>
                                </select>
                                <div id="networkWarning" class="hidden mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                                    ‚ö†Ô∏è This network may have higher fees ($3-5) for small transactions. Consider using Polygon for better rates.
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                                <select id="paymentCurrency" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="">Select network first</option>
                                </select>
                            </div>

                            <div id="optimismOptimization" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-sm font-medium text-blue-800 mb-2">üí° Gas Optimization Available</p>
                                <label class="flex items-center space-x-2 text-sm text-blue-700">
                                    <input type="checkbox" id="useDirectTransfer" class="rounded">
                                    <span>Use direct transfer (90% lower fees, instant payment)</span>
                                </label>
                                <p class="text-xs text-blue-600 mt-1">Direct: ~$0.05 | Splitter: ~$0.61</p>
                            </div>

                            <button onclick="connectMetaMaskAndPay()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                <span class="loading" id="paymentLoading"><i class="fas fa-spinner fa-spin mr-2"></i></span>
                                <i class="fas fa-wallet mr-2"></i>Connect MetaMask & Pay
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-blue-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <i class="fas fa-wallet text-blue-600 text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Processing Payment</h3>
                        <p class="text-gray-600">$<span id="paymentAmount">0.00</span> via <span id="paymentCurrencyDisplay">USDT</span></p>
                    </div>

                    <div id="walletStatus" class="mb-6"></div>

                    <div id="paymentSteps" class="space-y-4 mb-6">
                        <div class="flex items-center space-x-3">
                            <div id="step1" class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-xs font-semibold text-gray-600">1</span>
                            </div>
                            <span class="text-sm">Approve token spending</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div id="step2" class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-xs font-semibold text-gray-600">2</span>
                            </div>
                            <span class="text-sm">Execute payment</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div id="step3" class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-xs font-semibold text-gray-600">3</span>
                            </div>
                            <span class="text-sm">Verify payment</span>
                        </div>
                    </div>

                    <button onclick="closePaymentModal()" class="w-full border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6 text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-check text-green-600 text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">Payment Successful!</h3>
                    <p class="text-gray-600 mb-6">Your tickets have been purchased. Check your email for confirmation.</p>
                    <button onclick="closeSuccessModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // const COINLEY_CONFIG = {
        //     baseUrl:"http://localhost:9000",
        //     apiKey:"fdb87b029d8fb531589df71e17a8cc55", // for ecstasy local
        //     apiSecret:"5fe381f54803f100312117028542e952bd5d3d1d8b8df2dd1d0761c030cda4bf", // for ecstasy local
        // };
        const COINLEY_CONFIG = {
            baseURL: 'https://talented-mercy-production.up.railway.app',
            apiKey: 'afb78ff958350b9067798dd077c28459',
            apiSecret: 'c22d3879eff18c2d3f8f8a61d4097c230a940356a3d139ffceee11ba65b1a34c'
        };

        const sampleEvents = [
            { id: 1, title: "NBA Finals Game 7", date: "2024-02-15", time: "20:00", venue: "Madison Square Garden", price: 0.1, image: "https://images.unsplash.com/photo-1546519638-68e109498ffc?w=400" },
            { id: 2, title: "Premier League Derby", date: "2024-02-18", time: "15:30", venue: "Emirates Stadium", price: 1.99, image: "https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=400" },
            { id: 3, title: "Champions League Final", date: "2024-02-25", time: "19:00", venue: "Wembley Stadium", price: 4.99, image: "https://images.unsplash.com/photo-1522778119026-d647f0596c20?w=400" }
        ];

        let cart = [];
        let currentPayment = null;
        let web3 = null;
        let userAccount = null;
        let availableNetworks = [];
        let networkTokens = {};

        document.addEventListener('DOMContentLoaded', async function() {
            loadEvents();
            updateCartUI();
            await loadNetworks();
        });

        async function loadNetworks() {
            try {
                const response = await axios.get(`${COINLEY_CONFIG.baseURL}/api/networks`);
                availableNetworks = response.data.networks.filter(n => !n.isTestnet);
                
                // Sort networks by cost-effectiveness for small transactions
                const sortedNetworks = availableNetworks.sort((a, b) => {
                    const costRanking = {
                        'polygon': 1,
                        'bsc': 2,
                        'base': 3,
                        'arbitrum': 4,
                        'optimism': 5,
                        'avalanche': 6,
                        'ethereum': 7
                    };
                    return (costRanking[a.shortName] || 99) - (costRanking[b.shortName] || 99);
                });
                
                const networkSelect = document.getElementById('paymentNetwork');
                networkSelect.innerHTML = sortedNetworks.map(network => {
                    const costIndicator = network.shortName === 'polygon' || network.shortName === 'bsc' 
                        ? ' üíö (Low fees)' 
                        : network.shortName === 'optimism' || network.shortName === 'arbitrum'
                        ? ' ‚ö†Ô∏è (Higher fees)'
                        : '';
                    return `<option value="${network.shortName}">${network.name}${costIndicator}</option>`;
                }).join('');

                networkSelect.addEventListener('change', async (e) => {
                    const selectedNetwork = e.target.value;
                    await loadTokensForNetwork(selectedNetwork);

                    // Show optimization option for Optimism
                    const optimizationDiv = document.getElementById('optimismOptimization');
                    if (selectedNetwork === 'optimism' || selectedNetwork === 'arbitrum') {
                        optimizationDiv.classList.remove('hidden');
                    } else {
                        optimizationDiv.classList.add('hidden');
                    }
                    
                    // Show warning for high-fee networks with specific fee estimates
                    const networkWarning = document.getElementById('networkWarning');
                    const highFeeNetworks = ['optimism', 'arbitrum', 'ethereum'];
                    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                    if (highFeeNetworks.includes(selectedNetwork)) {
                        let warningText = '';
                        let estimatedFee = 0;

                        if (selectedNetwork === 'optimism') {
                            // Optimism fee estimation based on actual data
                            estimatedFee = 0.61; // Based on your logs
                            warningText = `‚ö†Ô∏è OPTIMISM ALERT: Expected fee ~$${estimatedFee} (${(estimatedFee/total*100).toFixed(0)}% of $${total.toFixed(2)} transaction). This is due to L1 data posting costs. Switch to Polygon for ~$0.01 fees.`;
                        } else if (selectedNetwork === 'arbitrum') {
                            estimatedFee = 0.50;
                            warningText = `‚ö†Ô∏è ARBITRUM may charge ~$${estimatedFee} in fees. Consider Polygon or BSC for minimal fees.`;
                        } else if (selectedNetwork === 'ethereum') {
                            estimatedFee = 15;
                            warningText = `üö® ETHEREUM MAINNET: Fees typically $10-20. DO NOT USE for small transactions! Use Polygon instead.`;
                        }

                        networkWarning.innerHTML = `
                            <div class="flex items-start space-x-2">
                                <span class="text-yellow-600 font-bold">!</span>
                                <div>
                                    <div class="font-semibold">${warningText}</div>
                                    <div class="mt-1 text-xs">Recommended: Polygon (MATIC) ‚Ä¢ BSC (BNB) ‚Ä¢ Base</div>
                                </div>
                            </div>
                        `;
                        networkWarning.classList.remove('hidden');
                    } else {
                        networkWarning.classList.add('hidden');
                    }
                });

                // Default to Polygon (cheapest for small transactions)
                if (sortedNetworks.length > 0) {
                    // Default to Polygon for lowest fees
                    const polygonNetwork = sortedNetworks.find(n => n.shortName === 'polygon');
                    const defaultNetwork = polygonNetwork ? 'polygon' : sortedNetworks[0].shortName;
                    networkSelect.value = defaultNetwork;
                    await loadTokensForNetwork(defaultNetwork);
                }
            } catch (error) {
                console.error('Failed to load networks:', error);
                alert('Failed to load payment networks. Please refresh the page.');
            }
        }

        async function loadTokensForNetwork(networkShortName) {
            try {
                const network = availableNetworks.find(n => n.shortName === networkShortName);
                if (!network) return;

                const response = await axios.get(`${COINLEY_CONFIG.baseURL}/api/networks/${network.id}/tokens`);
                networkTokens[networkShortName] = response.data.tokens;

                const currencySelect = document.getElementById('paymentCurrency');
                currencySelect.innerHTML = response.data.tokens.map(token =>
                    `<option value="${token.symbol}">${token.symbol} - ${token.name}</option>`
                ).join('');
            } catch (error) {
                console.error('Failed to load tokens:', error);
            }
        }

        function loadEvents() {
            const grid = document.getElementById('eventsGrid');
            grid.innerHTML = sampleEvents.map(event => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                    <img src="${event.image}" alt="${event.title}" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">${event.title}</h3>
                        <p class="text-gray-600 mb-1"><i class="fas fa-calendar mr-2"></i>${event.date} at ${event.time}</p>
                        <p class="text-gray-600 mb-4"><i class="fas fa-map-marker-alt mr-2"></i>${event.venue}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-blue-600">$${event.price}</span>
                            <button onclick="addToCart(${event.id})" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addToCart(eventId) {
            const event = sampleEvents.find(e => e.id === eventId);
            const existingItem = cart.find(item => item.id === eventId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...event, quantity: 1 });
            }
            updateCartUI();
        }

        function updateCartUI() {
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = cartCount;

            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');

            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">Your cart is empty</p>';
                cartTotal.textContent = '0.00';
                return;
            }

            cartItems.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center p-4 border rounded-lg">
                    <div>
                        <h4 class="font-semibold">${item.title}</h4>
                        <p class="text-gray-600 text-sm">${item.date}</p>
                        <p class="text-blue-600 font-semibold">$${item.price} x ${item.quantity}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="updateQuantity(${item.id}, -1)" class="text-red-600"><i class="fas fa-minus"></i></button>
                        <span class="font-semibold">${item.quantity}</span>
                        <button onclick="updateQuantity(${item.id}, 1)" class="text-blue-600"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            `).join('');

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotal.textContent = total.toFixed(2);
        }

        function updateQuantity(eventId, change) {
            const item = cart.find(item => item.id === eventId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    cart = cart.filter(cartItem => cartItem.id !== eventId);
                }
                updateCartUI();
            }
        }

        async function connectMetaMaskAndPay() {
            const email = document.getElementById('customerEmail').value;
            const network = document.getElementById('paymentNetwork').value;
            const currency = document.getElementById('paymentCurrency').value;

            if (!email) {
                alert('Please enter your email address');
                return;
            }

            if (cart.length === 0) {
                alert('Your cart is empty');
                return;
            }

            const loading = document.getElementById('paymentLoading');
            loading.classList.add('active');

            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to continue');
                    window.open('https://metamask.io/download/', '_blank');
                    return;
                }

                web3 = new Web3(window.ethereum);

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found');
                }

                userAccount = accounts[0];
                console.log('Connected account:', userAccount);

                await switchToNetwork(network);

                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                console.log('Creating payment:', { total, currency, network, email });

                const response = await axios.post(`${COINLEY_CONFIG.baseURL}/api/payments/create`, {
                    amount: total.toFixed(2),
                    currency: currency,
                    network: network,
                    customerEmail: email,
                    orderId: `TICKET_${Date.now()}`,
                    metadata: {
                        tickets: cart,
                        platform: 'SportsPass'
                    }
                }, {
                    headers: {
                        'X-API-Key': COINLEY_CONFIG.apiKey,
                        'X-API-Secret': COINLEY_CONFIG.apiSecret,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.data.success) {
                    currentPayment = response.data.payment;
                    console.log('Payment created:', currentPayment);
                    closeCart();
                    showPaymentModal();
                    await executePayment();
                } else {
                    throw new Error(response.data.message || 'Payment creation failed');
                }

            } catch (error) {
                console.error('Payment error:', error);
                alert('Payment failed: ' + error.message);
            } finally {
                loading.classList.remove('active');
            }
        }

        async function switchToNetwork(networkShortName) {
            const network = availableNetworks.find(n => n.shortName === networkShortName);
            if (!network) throw new Error('Network not found');

            const chainIdHex = '0x' + parseInt(network.chainId).toString(16);

            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: chainIdHex }]
                });
            } catch (error) {
                if (error.code === 4902) {
                    alert(`Please add ${network.name} network to MetaMask manually`);
                }
                throw new Error(`Failed to switch to ${network.name}`);
            }
        }

        async function executeDirectTransfer(tokenData) {
            try {
                console.log('=== DIRECT TRANSFER OPTIMIZATION ===');
                const decimals = tokenData.decimals || 6;
                const amount = parseFloat(currentPayment.amount);
                const amountWei = (amount * Math.pow(10, decimals)).toString();

                const erc20ABI = [
                    {"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"type":"function"},
                    {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}
                ];

                const tokenContract = new web3.eth.Contract(erc20ABI, tokenData.contractAddress);

                // Check balance first
                const balance = await tokenContract.methods.balanceOf(userAccount).call();
                console.log('User balance:', balance, 'Required:', amountWei);

                if (BigInt(balance) < BigInt(amountWei)) {
                    throw new Error('Insufficient token balance');
                }

                updateStatus('Sending direct transfer...', 'blue');
                updateStep(1, 'completed');
                updateStep(2, 'loading');

                // Estimate gas for direct transfer (much lower than splitter)
                const gasEstimate = await tokenContract.methods
                    .transfer(currentPayment.merchantWallet, amountWei)
                    .estimateGas({ from: userAccount });

                console.log('Direct transfer gas estimate:', gasEstimate, '(vs splitter: 403490)');
                console.log('Savings: ~' + ((403490 - gasEstimate) / 403490 * 100).toFixed(0) + '% gas reduction');

                const tx = await tokenContract.methods
                    .transfer(currentPayment.merchantWallet, amountWei)
                    .send({
                        from: userAccount,
                        gas: Math.ceil(gasEstimate * 1.1)
                    });

                console.log('Direct transfer successful:', tx.transactionHash);

                updateStep(2, 'completed');
                updateStep(3, 'loading');
                updateStatus('Verifying payment...', 'blue');

                // Record direct transfer with backend
                await axios.post(`${COINLEY_CONFIG.baseURL}/api/payments/process`, {
                    paymentId: currentPayment.id,
                    transactionHash: tx.transactionHash,
                    network: currentPayment.network,
                    senderAddress: userAccount,
                    isDirectTransfer: true
                }, {
                    headers: {
                        'X-API-Key': COINLEY_CONFIG.apiKey,
                        'X-API-Secret': COINLEY_CONFIG.apiSecret
                    }
                });

                updateStep(3, 'completed');
                updateStatus('Payment successful!', 'green');

                setTimeout(() => {
                    closePaymentModal();
                    showSuccessModal();
                    cart = [];
                    updateCartUI();
                }, 2000);

            } catch (error) {
                console.error('Direct transfer failed:', error);
                throw error;
            }
        }

        async function executePayment() {
            try {
                updateStep(1, 'loading');
                updateStatus('Preparing transaction...', 'blue');

                const networkShortName = currentPayment.network;
                const currency = currentPayment.currency;
                const tokenData = networkTokens[networkShortName].find(t => t.symbol === currency);

                if (!tokenData) {
                    throw new Error(`Token ${currency} not found for network ${networkShortName}`);
                }

                // Check if direct transfer optimization is enabled
                const useDirectTransfer = document.getElementById('useDirectTransfer')?.checked;

                if (useDirectTransfer && (networkShortName === 'optimism' || networkShortName === 'arbitrum')) {
                    console.log('üöÄ Using optimized direct transfer method');
                    await executeDirectTransfer(tokenData);
                    return;
                }

                // ADD CONSOLE LOG HERE - Debug contract details
                console.log('=== PAYMENT CONTRACT DETAILS ===');
                console.log('Network:', currentPayment.network);
                console.log('Contract Address:', currentPayment.contractAddress);
                console.log('Splitter Payment ID:', currentPayment.splitterPaymentId);
                console.log('Amount:', currentPayment.amount);
                console.log('Token Address:', tokenData.contractAddress);
                console.log('Merchant Wallet:', currentPayment.merchantWallet);
                console.log('Coinley Wallet:', currentPayment.coinleyWallet);
                console.log('================================');

                const decimals = tokenData.decimals || 6;
                const amount = parseFloat(currentPayment.amount);
                const amountWei = (amount * Math.pow(10, decimals)).toString();

                const erc20ABI = [
                    {"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"type":"function"},
                    {"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function"},
                    {"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"type":"function"},
                    {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}
                ];

                const tokenContract = new web3.eth.Contract(erc20ABI, tokenData.contractAddress);

                // updateStatus('Checking token allowance...', 'blue');

                // // Check existing allowance first to avoid unnecessary approval
                // const existingAllowance = await tokenContract.methods
                //     .allowance(userAccount, currentPayment.contractAddress)
                //     .call();

                // console.log('Existing allowance:', existingAllowance);
                // console.log('Required amount:', amountWei);

                    // ‚úÖ CHECK BALANCE FIRST - Critical fix for "exceeds balance" error
                updateStatus('Checking wallet balance...', 'blue');
                
                const userBalance = await tokenContract.methods.balanceOf(userAccount).call();
                const userBalanceDecimal = parseFloat(userBalance) / Math.pow(10, decimals);
                
                console.log('üí∞ Balance Check:', {
                    requiredAmount: amount,
                    walletBalance: userBalanceDecimal,
                    token: currency,
                    sufficient: userBalanceDecimal >= amount
                });

                if (userBalanceDecimal < amount) {
                    const shortfall = (amount - userBalanceDecimal).toFixed(2);
                    throw new Error(
                        `Insufficient ${currency} balance!\n\n` +
                        `Required: ${amount} ${currency}\n` +
                        `Available: ${userBalanceDecimal.toFixed(2)} ${currency}\n` +
                        `Shortfall: ${shortfall} ${currency}\n\n` +
                        `Please add more ${currency} to your wallet or reduce cart amount.`
                    );
                }

                updateStatus('Checking token allowance...', 'blue');

                if (BigInt(existingAllowance) < BigInt(amountWei)) {
                    console.log('Insufficient allowance, requesting approval...');
                    updateStatus('Approve token spending in MetaMask...', 'yellow');

                    const approveTx = await tokenContract.methods
                        .approve(currentPayment.contractAddress, amountWei)
                        .send({ from: userAccount });

                    console.log('Approval transaction:', approveTx.transactionHash);
                    updateStep(1, 'completed');
                } else {
                    console.log('‚úÖ Sufficient allowance exists, skipping approval');
                    updateStatus('Token already approved, proceeding...', 'green');
                    updateStep(1, 'completed');
                }
                updateStep(2, 'loading');
                updateStatus('Executing payment...', 'blue');

                const splitterABI = [{
                    "inputs":[{
                        "components": [
                            {"name":"token","type":"address"},
                            {"name":"amount","type":"uint256"},
                            {"name":"paymentId","type":"string"},
                            {"name":"recipient1","type":"address"},
                            {"name":"recipient2","type":"address"},
                            {"name":"recipient3","type":"address"},
                            {"name":"recipient1Percentage","type":"uint256"},
                            {"name":"recipient2Percentage","type":"uint256"},
                            {"name":"recipient3Percentage","type":"uint256"}
                        ],
                        "name":"params",
                        "type":"tuple"
                    }],
                    "name":"splitPayment",
                    "outputs":[],
                    "stateMutability":"nonpayable",
                    "type":"function"
                }];

                const splitterContract = new web3.eth.Contract(splitterABI, currentPayment.contractAddress);

                // Prepare SplitParams struct - contract expects 3 recipients
                // ‚úÖ CRITICAL FIX: Use the FULL payment ID as-is (UUID string)
                // The smart contract expects a string, not a hash or truncated value
                const paymentId = currentPayment.splitterPaymentId || currentPayment.id;

                console.log('‚úÖ Using full payment ID for contract:', {
                    paymentId: paymentId,
                    type: typeof paymentId,
                    length: paymentId.length
                });

                const splitParams = {
                    token: tokenData.contractAddress,
                    amount: amountWei,
                    paymentId: paymentId, // ‚úÖ FIX: Use full UUID string, not hash
                    recipient1: currentPayment.merchantWallet,
                    recipient2: currentPayment.coinleyWallet,
                    recipient3: '0x0000000000000000000000000000000000000000', // No third recipient
                    recipient1Percentage: currentPayment.merchantPercentage,
                    recipient2Percentage: currentPayment.coinleyPercentage,
                    recipient3Percentage: 0
                };

                console.log('Split params:', splitParams);

                // Estimate gas for splitPayment before executing
                let splitGasEstimate;
                let gasPrice;
                try {
                    console.log('Estimating gas for splitPayment...');
                    splitGasEstimate = await splitterContract.methods
                        .splitPayment(splitParams)
                        .estimateGas({ from: userAccount });

                    console.log('SplitPayment gas estimate:', splitGasEstimate);

                    // Calculate actual cost on Optimism
                    gasPrice = await web3.eth.getGasPrice();
                    console.log('Gas Price (wei):', gasPrice.toString());

                    // L2 execution cost
                    const l2ExecutionCost = (BigInt(splitGasEstimate) * BigInt(gasPrice)) / BigInt(1e9); // in Gwei
                    const l2ExecutionCostEth = Number(l2ExecutionCost) / 1e9; // Convert to ETH

                    // Estimate L1 data cost by encoding the function call
                    let calldataSize = 0;
                    try {
                        // Encode the actual function call to estimate calldata size
                        const encodedData = splitterContract.methods.splitPayment(splitParams).encodeABI();
                        calldataSize = encodedData.length / 2; // Convert hex to bytes
                    } catch (encodeError) {
                        console.warn('Could not estimate calldata size:', encodeError);
                        // Rough estimate: 4 (function selector) + 32*9 (parameters) = ~292 bytes
                        calldataSize = 292;
                    }

                    // Optimism L1 data cost calculation (Fjord upgrade formula)
                    // Get current L1 base fee from Optimism oracle
                    let l1BaseFee = 30 * 1e9; // Default 30 gwei
                    try {
                        // Try to get actual L1 base fee from Optimism's GasPriceOracle
                        const gasPriceOracleAddress = '0x420000000000000000000000000000000000000F';
                        const oracleABI = [{"constant":true,"inputs":[],"name":"l1BaseFee","outputs":[{"name":"","type":"uint256"}],"type":"function"}];
                        const oracle = new web3.eth.Contract(oracleABI, gasPriceOracleAddress);
                        l1BaseFee = await oracle.methods.l1BaseFee().call();
                        console.log('L1 Base Fee from Oracle:', l1BaseFee);
                    } catch (e) {
                        console.log('Using default L1 base fee');
                    }

                    // Calculate compressed size (Optimism uses brotli compression)
                    const compressedSize = Math.ceil(calldataSize * 0.4); // Approximate 60% compression
                    const l1DataGas = compressedSize * 16; // 16 gas per compressed byte
                    const l1DataCostEth = (l1DataGas * l1BaseFee) / 1e18;

                    // Total cost = L2 execution + L1 data posting
                    const totalCostEth = l2ExecutionCostEth + l1DataCostEth;

                    // Calculate estimated USD cost
                    const ethPrice = 3000; // Approximate ETH price
                    const estimatedUsdCost = totalCostEth * ethPrice;
                    const feePercentage = (estimatedUsdCost / parseFloat(currentPayment.amount)) * 100;

                    console.log('Gas Analysis:', {
                        gasUnits: splitGasEstimate,
                        gasPrice: gasPrice.toString() + ' wei',
                        calldataSize: calldataSize + ' bytes',
                        l1DataGas: l1DataGas + ' units',
                        l2ExecutionCostETH: l2ExecutionCostEth.toFixed(8) + ' ETH',
                        l1DataCostETH: l1DataCostEth.toFixed(8) + ' ETH',
                        totalCostETH: totalCostEth.toFixed(8) + ' ETH',
                        estimatedUsdCost: '$' + estimatedUsdCost.toFixed(2),
                        transactionValue: '$' + currentPayment.amount,
                        feePercentage: feePercentage.toFixed(1) + '%',
                        warningThreshold: splitGasEstimate > 150000 ? 'HIGH' : 'NORMAL'
                    });

                    // Dynamic fee threshold based on transaction value
                    const acceptableFeePercentage = 5; // 5% max acceptable fee
                    const isHighFee = feePercentage > acceptableFeePercentage;

                    if (isHighFee || splitGasEstimate > 150000) {
                        console.warn('‚ö†Ô∏è HIGH FEE ALERT!');
                        console.warn('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                        console.warn(`üìä Transaction: $${currentPayment.amount}`);
                        console.warn(`üí∏ Estimated Fee: $${estimatedUsdCost.toFixed(2)} (${feePercentage.toFixed(0)}% of transaction)`);
                        console.warn(`üìà Gas Units: ${splitGasEstimate.toLocaleString()}`);
                        console.warn('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                        console.warn('üí∞ Cost Breakdown:');
                        console.warn(`   L2 Execution: $${(l2ExecutionCostEth * ethPrice).toFixed(2)}`);
                        console.warn(`   L1 Data Post: $${(l1DataCostEth * ethPrice).toFixed(2)}`);
                        console.warn(`   Calldata Size: ${calldataSize} bytes`);
                        console.warn('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                        console.warn('üöÄ RECOMMENDATIONS:');
                        console.warn('   1. Switch to Polygon: ~$0.01 fees');
                        console.warn('   2. Switch to BSC: ~$0.02 fees');
                        console.warn('   3. Batch multiple tickets: Share L1 costs');
                        console.warn('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

                        // Alert user about high fees
                        if (feePercentage > 50) {
                            updateStatus(`‚ö†Ô∏è WARNING: Gas fee ($${estimatedUsdCost.toFixed(2)}) is ${feePercentage.toFixed(0)}% of transaction!`, 'red');
                        }
                    }
                } catch (splitGasError) {
                    console.error('SplitPayment gas estimation failed:', splitGasError);
                    console.error('Error details:', splitGasError.message);
                    throw new Error('Payment contract call will fail: ' + splitGasError.message);
                }

                // Ensure gasPrice is available
                if (!gasPrice) {
                    gasPrice = await web3.eth.getGasPrice();
                    console.log('Using fallback gas price:', gasPrice.toString());
                }

                // Optimize gas limit for Optimism
                const optimizedGasLimit = Math.min(
                    Math.ceil(splitGasEstimate * 1.1), // 10% buffer instead of 20%
                    450000 // Lower max to force optimization
                );

                console.log('Executing payment with optimized gas:', {
                    estimated: splitGasEstimate,
                    withBuffer: optimizedGasLimit,
                    maxAllowed: 450000
                });

                const paymentTx = await splitterContract.methods
                    .splitPayment(splitParams)
                    .send({
                        from: userAccount,
                        gas: optimizedGasLimit,
                        gasPrice: gasPrice.toString() // Explicit gas price
                    });

                console.log('Payment transaction:', paymentTx.transactionHash);

                updateStep(2, 'completed');
                updateStep(3, 'loading');
                updateStatus('Verifying payment...', 'blue');

                await verifyPayment(paymentTx.transactionHash);

                updateStep(3, 'completed');
                updateStatus('Payment successful!', 'green');

                setTimeout(() => {
                    closePaymentModal();
                    showSuccessModal();
                    cart = [];
                    updateCartUI();
                }, 2000);

            } catch (error) {
                console.error('Payment execution failed:', error);
                updateStatus('Payment failed: ' + error.message, 'red');
                
                if (currentPayment && currentPayment.id) {
                    await axios.post(`${COINLEY_CONFIG.baseURL}/api/payments/fail`, {
                        paymentId: currentPayment.id,
                        reason: error.message
                    }, {
                        headers: {
                            'X-API-Key': COINLEY_CONFIG.apiKey,
                            'X-API-Secret': COINLEY_CONFIG.apiSecret
                        }
                    }).catch(err => console.error('Failed to record payment failure:', err));
                }
            }
        }

        async function verifyPayment(txHash) {
            const response = await axios.post(`${COINLEY_CONFIG.baseURL}/api/payments/process`, {
                paymentId: currentPayment.id,
                transactionHash: txHash,
                network: currentPayment.network,
                senderAddress: userAccount
            }, {
                headers: {
                    'X-API-Key': COINLEY_CONFIG.apiKey,
                    'X-API-Secret': COINLEY_CONFIG.apiSecret,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.data.success) {
                throw new Error(response.data.error || 'Verification failed');
            }
        }

        function updateStep(stepNum, status) {
            const step = document.getElementById(`step${stepNum}`);
            step.className = 'w-6 h-6 rounded-full flex items-center justify-center';

            if (status === 'loading') {
                step.className += ' bg-blue-500 text-white';
                step.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i>';
            } else if (status === 'completed') {
                step.className += ' bg-green-500 text-white';
                step.innerHTML = '<i class="fas fa-check text-xs"></i>';
            } else {
                step.className += ' bg-gray-200 text-gray-600';
                step.innerHTML = `<span class="text-xs font-semibold">${stepNum}</span>`;
            }
        }

        function updateStatus(message, color) {
            const colors = {
                blue: 'bg-blue-50 text-blue-800 border-blue-200',
                green: 'bg-green-50 text-green-800 border-green-200',
                yellow: 'bg-yellow-50 text-yellow-800 border-yellow-200',
                red: 'bg-red-50 text-red-800 border-red-200'
            };

            document.getElementById('walletStatus').innerHTML = `
                <div class="p-4 rounded-lg border ${colors[color]}">
                    <p class="text-sm font-medium">${message}</p>
                </div>
            `;
        }

        function showPaymentModal() {
            document.getElementById('paymentAmount').textContent = currentPayment.amount;
            document.getElementById('paymentCurrencyDisplay').textContent = currentPayment.currency;
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        document.getElementById('cartBtn').addEventListener('click', () => {
            document.getElementById('cartModal').classList.remove('hidden');
        });

        function closeCart() {
            document.getElementById('cartModal').classList.add('hidden');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        function showSuccessModal() {
            document.getElementById('successModal').classList.remove('hidden');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        function scrollToEvents() {
            document.getElementById('events').scrollIntoView({ behavior: 'smooth' });
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('bg-black')) {
                closeCart();
                closePaymentModal();
                closeSuccessModal();
            }
        });
    </script>
</body>
</html>